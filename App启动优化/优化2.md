# 优化2

### App 启动时都干了些什么事儿？  
一般情况下，App 的启动分为冷启动和热启动。  
- 冷启动是指， App 点击启动前，它的进程不在系统里，需要系统新创建一个进程分配给它启动的情况。这是一次完整的启动过程。  
- 热启动是指 ，App 在冷启动后用户将 App 退后台，在 App 的进程还在系统里的情况下，用户重新启动进入 App 的过程，这个过程做的事情非常少。  

所以我们就只展开讲 App 冷启动的优化。用户能感知到的启动慢，其实都发生在主线程上。而主线程慢的原因有很多，比如在主线程上执行了大文件读写操作、在渲染周期中执行了大量计算等。但是，有时你会发现即使你把首屏显示之前的这些主线程的耗时问题都解决了，还是比竞品启动得慢.  

一般而言，App 的启动时间，指的是从用户点击 App 开始，到用户看到第一个界面之间的时间。总结来说，App 的启动主要包括三个阶段：  

1. main() 函数执行前；
2. main() 函数执行后；
3. 首屏渲染完成后  

### main() 函数执行前  

在 main() 函数执行前，系统主要会做下面几件事情：
- 加载可执行文件（App 的.o 文件的集合）；
- 加载动态链接库，进行 rebase 指针调整和 bind 符号绑定；
- Objc 运行时的初始处理，包括 Objc 相关类的注册、category 注册、selector 唯一性检查等；
- 初始化，包括了执行 +load() 方法、attribute((constructor)) 修饰的函数的调用、创建 C++ 静态全局变量。

相应地，这个阶段对于启动速度优化来说，可以做的事情包括：  

- 减少动态库加载, 可以编译为静态库, [这里](https://blog.automatic.com/how-we-cut-our-ios-apps-launch-time-in-half-with-this-one-cool-trick-7aca2011e2ea?gi=4fb6f52b2a23)是一个老外的做法  
- 减少加载启动后不会去使用的类或者方法
- +load() 方法里的内容可以放到首屏渲染完成后再执行，或使用 +initialize() 方法替换掉。因为，在一个 +load() 方法里，进行运行时方法替换操作会带来 4 毫秒的消耗。不要小看这 4 毫秒，积少成多，执行 +load() 方法对启动速度的影响会越来越大
- 控制 C++ 全局变量的数量

上面提到减少加载启动后不会去使用的类或者方法, 那么怎么知道哪些类或者方法是不使用的呢?  

首先, [这里](https://github.com/alaksh10/xcodeutils)和[这里](https://www.jianshu.com/p/1b188a91b23f)有一个脚本文件可以方便的找到项目中未使用的类和方法, 如果是swift, [这里](https://medium.com/@gabriel_lewis/how-to-easily-find-unused-swift-code-in-xcode-159631961acf)也有脚本, [这里](https://medium.com/@port001/swift-find-unused-code-9cdf6b1f41ca)也可以    