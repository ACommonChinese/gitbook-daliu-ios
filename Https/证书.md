# 证书

公开密钥加密的一个问题是如何证明公开密钥本身就是货真价实的公开密钥. 比如正准备和某台服务器建立公开密钥加密方式下的通信时, 如何证明收到的公开密钥就是原本预想的那台服务器发行的公开密钥, 有可能在公开密钥的传输途中, 真正的公开密钥已经被攻击者替换掉了.  

为了解决上述问题, 可以使用由数字证书认证机构(CA, Certificate Authority)和其相关机关颁发的公开密钥证书.  

CA处于client和server双方都可依赖的第三方机构的立场上, 比如威瑞信(VeriSign)就是其中一家非常有名的数字证书认证机构.  

流程: 
- 向CA申请公钥
- CA判明申请者身份后, 对公钥进行数字签名, 并将该公开密钥放入公钥证书后绑定在一起, 给到申请人
- server把公钥证书发送给client
- client使用CA的公开密钥对证书验证签名(公钥加密, 私钥解密, 私钥签名, 公钥验证签名)

client使用CA的公开密钥对server发送过来的证书验证, 本质上是使用CA的公钥去这个证书验证签名; 这一步也被称为Certificate Pin, 如果验证通过, 就可以确认这个证书是CA认证过的有效的可信证书, 但是client是什么时候得到CA的公钥证书呢? CA的公钥证书的转交是一件困难的事, 因此多数浏览器开发商发布版本时会事先在内部植入常用认证机构的公钥证书  
注: client对server证书的验证分为certificate pin和server pin, 上面只是确证certificate pin成功, 即证书是CA颁发的可信证书, 但server pin即确认服务器是真实的服务器是另外一回事, 因为中间人依然有可能有自己的CA颁发的证书, 而把这个证书给转交给了client  

### 可证明组织真实性的EV SSL证书  

证明的一个作用是用来证明作为通信一方的服务器是否规范, 另外一个作用是可确认对方服务器背后运营的企业是否真实存在. 拥有该特性的证书就是EV SSL证书(Extended Validation SSL Certificate)  
持有EV SSL证书的Web网站的浏览器地址栏处的背景色是绿色的  

### 客户端证书 

客户端证书也需要付费购买, 每张证书对应每位用户意味着支付和用户数对等的费用. 因此一般用于特殊用途的业务. 比如操作银行卡转帐等业务时使用的U盾  

### 自签名证书  

使用OpenSSL这套开源程序可以构建属于自己的认证机构, 从而自己给自己颁发服务器证书, 即自签字证书.  
但是, 由于浏览器内植的CA的公钥证书无法完成对自签名证书的认证(验签), 一些浏览器会显示"无法确认连接安全性"等警告

### 根证书一般会直接被预装在操作系统或浏览器内 
[Apple](https://support.apple.com/zh-cn/HT209144)  

## 关于信任和证书

各个受信任证书存储区均包含三类证书：

- [“可信”的证书](https://support.apple.com/zh-cn/HT209144#trusted)会建立信任链，以验证由可信根签名的其他证书；例如，与网页服务器建立安全连接。IT 管理员在创建配置描述文件时，无需提供这些受信任的根证书。
- [“始终询问”的证书](https://support.apple.com/zh-cn/HT209144#alwaysask)不受信任，但不会被阻止。使用其中任一证书时，系统将提示您选择是不是信任这个证书。
- [“已阻止”的证书](https://support.apple.com/zh-cn/HT209144#blocked)视为已被盗用，将永远不再受信任。

请按照以下步骤查找您的 iOS 设备上安装的受信任证书存储区版本：

1. 轻点“设置”>“通用”>“关于本机”
2. 滚动到列表底部
3. 轻点“证书信任设置”

请按照以下步骤查找您的 Mac 上安装的受信任证书存储区版本：

1. 在“访达”中，选取“前往”>“前往文件夹”。
2. 键入或粘贴 /System/Library/Security/Certificates.bundle/Contents/Resources/TrustStore.html，然后点按“前往”。
3. 在出现的文件夹中，打开 TrustStore.html。受信任证书存储区版本显示在页面右上角。

本文列出了受信任证书存储区版本 2018071800 的证书，这是适用于 iOS 12、macOS 10.14、watchOS 5 和 tvOS 12 的最新版证书。

--------------------------------

### 数字证书的内容

[oschina](https://my.oschina.net/u/3729367/blog/1590724)

X.509 应该是比较流行的 SSL 数字证书标准，包含（但不限于）以下的字段：

| 字段                            | 值说明                                                       |
| ------------------------------- | ------------------------------------------------------------ |
| 对象名称（Subject Name）        | 用于识别该数字证书的信息                                     |
| 共有名称（Common Name）         | 对于客户证书，通常是相应的域名                               |
| 证书颁发者（Issuer Name）       | 发布并签署该证书的实体的信息                                 |
| 签名算法（Signature Algorithm） | 签名所使用的算法                                             |
| 序列号（Serial Number）         | 数字证书机构（Certificate Authority， CA）给证书的唯一整数，一个数字证书一个序列号 |
| 生效期（Not Valid Before）      | (｀・ω・´)                                                   |
| 失效期（Not Valid After）       | (╯°口°)╯(┴—┴                                                 |
| 公钥（Public Key）              | 可公开的密钥                                                 |
| 签名（Signature）               | 通过签名算法计算证书内容后得到的数据，用于验证证书是否被篡改 |

### 数字证书的生成及验证

- 数字证书的生成是分层级的，下一级的证书需要其上一级证书的私钥签名。 所以后者是前者的证书颁发者，也就是说上一级证书的 Subject Name 是其下一级证书的 Issuer Name。
- 在得到证书申请者的一些必要信息（对象名称，公钥私钥）之后，证书颁发者通过 SHA-256 哈希得到证书内容的摘要，再用自己的私钥给这份摘要加密，得到数字签名。综合已有的信息，生成分别包含公钥和私钥的两个证书。